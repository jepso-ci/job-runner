# job-runner

  Run Jobs for Jepso-CI

## Usage

```javascript
var run = require('job-runner');
run({
  sauce: function (fn) { return fn('sauce-user', 'sauce-key') }},
  commit: {user: 'user', repo: 'repo', tag: 'master'},
  buildCreatedTime: Date.now(),
  fileSystem: run.local(join(__dirname, 'user', 'repo', 'master'))
});
```

## Job Config

 - sauce - function(fn(user, key)) - Calls fn with a sauce labs user and key and guarantees that there will be at least one slot to run tests for that user and key until fn completes. returns a promise for the result of fn.
 - commit - object with the following properties
   - user - string
   - repo - string
   - tag - string
 - buildCreatedTime - Unix time stamp
 - fileSystem - object with the follwing 'methods'
   - get(path-to-file) - returns `promise(null)` if file does not exist, returns promise for file buffer otherwise
   - put(path-to-file, file-contents) - directory should be created if it does not exist, returns promise
   - putStream(path-to-file, file-contents-stream) - returns promise

## File System Output

Results are output into the folder:

~/

 - results.json - Contains a basic summary of results for all browser/version combos

From that, the following images will be created:

 - test-results-badge.svg - status badge generated by https://github.com/jepso-ci/test-results-badge
 - test-results-badge.png - png of above svg
 - ci-badge.png - status badge generated by https://github.com/visionmedia/ci-badge
 - browser-badge.png - status badge generated by https://github.com/substack/browser-badge

~/:browser/:version

 - log.json - Contains a log of events emmitted during the build, including the points at which screen shots were taken
 - :screenshotID.png - Screenshots taken during the build
 - report.json - Contains the report for the build
 - video.flv - Contains the video of the test run

### results.json format

  A JSON document with the following properties

   - user - the user of the repo
   - repo - the name of the GitHub repository
   - tag - the commit or branch the build worked on
   - start - unix time stamp for when the build was started
   - end - unix time stamp for when the build completed
   - browsers - An object with the following properties, each of which is an array of objects of type `{version: 'string', passed: true | false}`
     - android
     - chrome
     - firefox
     - internet explorer
     - ipad
     - iphone
     - opera
     - safari

### log.json

  The log takes the form of an array of log entry objects.

### report.json

  The report is an object with a `type` property which specifies the type of the rest of the report.

#### `type='html'`

  If `type='html'` then there will the a `text` property which contains a complete html document (minus doc-type and `<html>` `</html>` tags) as the report.

#### `type='timeout'`

  The build timed out and no further repoting is available

## Events

 - start(user, repo, buildID, {tag, start})
 - start-browser(user, repo, buildID, {browser, version});
 - finish-browser(user, repo, buildID, {browser, version, passed});
 - finish(user, repo, buildID, {tag, start, end})